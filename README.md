# Amp Stack   
Easy and fast installation of the latest version of the amp stack (apache2 + ufw + sendmail + fail2ban + vsftpd + mariadb + php + npm + laravel + wp-cli) on ubuntu 18.04+.   
If you are using virtualhost see [here](https://github.com/w3src/sh-vhost).   

## Firewall   
If you are installing scripts on cloud servers like aws, gcloud and azure, you need to open the following ports.   
```
apache: 80/tcp, 443/tcp
ssh: 22/tcp
ftp: 20:21/tcp, 990/tcp, 12000:12100/tcp
mariadb: 3306/tcp
memcached: 11211/tcp
redis: 6379/tcp
elasticsearch: 9200/tcp
smtp: 25/tcp, 465/tcp, 587/tcp, 2525/tcp
pop3: 110/tcp, 995/tcp
imap: 143/tcp, 993/tcp
```

## Structure   
```
o
|-- os/
|   |-- os_version/
|   |   `-- package/
|   |       |-- etc/
|   |       |-- tmp/
|   |       `-- tmpl/
|   |-- functions.sh
|   `-- utils.sh
`-- env
```

## Syntax   
```
$ ./<command>.sh
or
$ ./<command>.sh <package-name> <package-name> <package-name>
```

## Download and Run the Script
```
$ sudo su
$ git clone https://github.com/w3src/sh-amp.git
$ cd sh-amp
$ chmod +x ./*.sh
$ ./install.sh
```

## Summary   
Summary of commands for each package.   
```
| package  | install | config | update | upgrade | reset | uninstall | wizard |
|----------|---------|--------|--------|---------|-------|-----------|--------|
| os       | o       | -      | -      | o       | -     | -         | -      |
| host     | o       | o      | -      | -       | -     | -         | -      |
| apache2  | o       | o      | -      | o       | o     | o         | o      |
| ufw      | o       | o      | -      | o       | o     | o         | -      |
| sendmail | o       | o      | -      | o       | o     | o         | o      |
| fail2ban | o       | o      | -      | o       | o     | o         | o      |
| vsftpd   | o       | o      | -      | o       | o     | o         | o      |
| mariadb  | o       | o      | -      | o       | o     | o         | o      |
| php      | o       | o      | -      | o       | o     | o         | -      |
| npm      | o       | -      | -      | o       | -     | o         | -      |
| laravel  | o       | -      | -      | -       | -     | -         | -      |
| wp-cli   | o       | -      | -      | o       | -     | -         | -      |
```

## Usage   

### Install   
Package installation.   
```
$ ./install.sh
or
$ ./install.sh os host apache2 ufw sendmail fail2ban vsftpd mariadb php npm laravel wp-cli
```

### List of installed php modules for wordpress and laravel   
For more information on [wordpress](https://make.wordpress.org/hosting/handbook/handbook/server-environment/#php-extensions) and [laravel](https://laravel.com/docs/7.x#server-requirements), see here.   
```
php-common
libapache2-mod-php
php-mysql
php-curl
php-json
php-mbstring
php-imagick
php-xml
php-zip
php-gd
php-ssh2
php-bcmath
php-json
php-xml
php-mbstring
php-tokenizer
php-oauth
composer
```

### Config   
The basic configuration of the package has been set.   
```
$ ./config.sh
or
$ ./config.sh host apache2 sendmail fail2ban vsftpd mariadb php
```

If you don't want the default configuration, you can use your own configuration file.   
This option copies all files in the amp stack package's etc directory with the path,   
unless the file name starts with _.   
```
# ./config.sh --my <package-name> <package-name> <package-name>
```

Example:   
```
# vi ./ubuntu/18.04/apache2/etc/conf-available/charset.conf
# ./config.sh --my apache2
```

### Update   
Download the latest version of the Amp Stack.   
```
$ ./update.sh
```

### Upgrade   
Run the package's apt upgrade.   
```
$ ./upgrade.sh
or
$ ./upgrade.sh os apache2 ufw sendmail fail2ban vsftpd mariadb php npm wp-cli
```

### Reset   
The configuration settings return to the initial settings.   
```
$ ./reset.sh
or
$ ./reset.sh apache2 ufw sendmail fail2ban vsftpd mariadb php
```

### Uninstall   
Remove the package completely.   
```
$ ./uninstall.sh
or
$ ./uninstall.sh apache2 ufw sendmail fail2ban vsftpd mariadb php npm
```

### Wizard   
Frequently used systemctl commands such as status, start, stop, reload, restart, enable, disable and etc.   
```
$ ./wizard.sh
or
$ ./wizard.sh apache2 fail2ban mariadb vsftpd
```

## Configuration   

### Apache2   

/etc/apache2/conf-available/charset.conf   
```
AddDefaultCharset UTF-8
```

/etc/apache2/conf-available/security.conf   
```
<Directory />
   AllowOverride None
   Require all denied
</Directory>
ServerTokens Prod
ServerSignature Off
Header set X-Content-Type-Options: "nosniff"
Header set X-Frame-Options: "sameorigin"
```

/etc/apache2/apache2.conf   
```
# This is a configuration dynamically generated by Amp Stack.

# Deny access to file and folder names beginning with dot.
#<DirectoryMatch "^\.|\/\.">
#    Require all denied
#</DirectoryMatch>
 
# Deny access to file extensions(log file, binary, certificate, shell script, sql dump file).
<FilesMatch "\.(?i:log|binary|pem|enc|crt|conf|cnf|sql|sh|key|yml|lock|gitignore)$">
    Require all denied
</FilesMatch>
 
# Deny access to file names.
<FilesMatch "(?i:composer\.json|contributing\.md|license\.txt|readme\.rst|readme\.md|readme\.txt|copyright|artisan|gulpfile\.js|package\.json|phpunit\.xml|access_log|error_log|gruntfile\.js|bower\.json|changelog\.md|console|legalnotice|license|security\.md|privacy\.md)$">
    Require all denied
</FilesMatch>
 
# Allow Lets Encrypt Domain Validation Program
<DirectoryMatch "\.well-known/acme-challenge/">
    Require all granted
</DirectoryMatch>
 
# Block .php file inside upload folder. uploads(wp), files(drupal), data(gnuboard).
<DirectoryMatch "/(uploads|default/files|data|wp-content/themes)/">
    <FilesMatch ".+\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# This is the last line of configuration dynamically generated by Amp Stack.
```

/etc/apache2/mods-available/mpm_prefork.conf   
```
StartServers            10
MinSpareServers         10
MaxSpareServers         20
MaxRequestWorkers       300
ServerLimit             300
MaxConnectionsPerChild  0
```

### Mariadb   
/etc/my.cnf   
```
[client]
default-character-set = utf8mb4

[mysql]
default-character-set = utf8mb4

[mysqldump]
default-character-set = utf8mb4

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
character-set-client-handshake = FALSE
```

### PHP   
/etc/apache2/mods-available/dir.conf   
```
DirectoryIndex index.php index.html index.cgi index.pl index.xhtml index.htm
```

/etc/apache2/mods-available/php\<PHP_VERSION\>.conf   
```
<FilesMatch ".+\.ph(ar|p[3457]?|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch "^\.ph(p[3457]?|t|tml|ps)$">
    Require all denied
</FilesMatch>
```

/etc/php/\<PHP_VERSION\>/apache2/php.ini   
```
[PHP]

;;;;;;;;;;;;;;;;;;;;
; Language Options ;
;;;;;;;;;;;;;;;;;;;;

short_open_tag = On

;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max_execution_time = 3600
max_input_time = 3600
max_input_vars = 10000
memory_limit = 256M

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Error handling and logging ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

display_errors = On
post_max_size = 1024M

;;;;;;;;;;;;;;;;
; File Uploads ;
;;;;;;;;;;;;;;;;

upload_max_filesize = 1024M
max_file_uploads = 100

;;;;;;;;;;;;;;;;;;;
; Module Settings ;
;;;;;;;;;;;;;;;;;;;

[Date]
date.timezone = <dynamic set system timezone>
```

## Support   
ubuntu 18.04+   

## License   
[MIT License](LICENSE)   